# Changelog - 2026-01-31

## Summary
Unified UserModal for create and edit modes with conditional group management based on role, Langue/Devise in both modes, and form-based batch save approach. Added error handling and edge case tests. Increased toast durations for reliable UI test verification. Executed all 22 UI tests via Chrome MCP (21 PASS, 1 SKIP). Added check_number field to transactions and expandable detail rows in the transaction list. Extended transaction search to include check_number field (partial match). Added search clear icon and filter reset button.

## Changes

- [client/src/pages/AdminUsers.jsx] Added pendingGroups state (create), localGroups state (edit), handleRoleChange handler, computeGroupChanges diff, and conditional group UI: super_admin hides groups entirely, user shows simple "Groupe" dropdown (both create and edit), admin supports multi-group "Groupes" management (both modes); unified Langue/Devise fields for both create and edit; added handleUserGroupChange handler and userGroupId computed value for unified user dropdown; edit mode refactored to form-based approach (local state, batch save on submit with toAdd/toRemove/toUpdateRole); removed individual group mutation callbacks; fixed memberRole→role normalization bug in useEffect sync and computeGroupChanges (API returns memberRole, frontend expected role); fixed create mode stripping empty firstName/lastName before sending to avoid Zod min(1) validation error
- [client/tests/pages/AdminUsers.test.jsx] Updated 7 tests for unified form behavior; added 16 error/edge case tests: API error handling for create, update, suspend, reactivate, role change (toast messages with server/fallback messages), empty field stripping, HTML required/minLength validation attributes, no-change edit closes modal, graceful handling of getUsers/getUser API failures, modal stays open after create error; total 66 tests passing
- [client/tests/ui/admin/users-groups.ui.test.js] Updated UI test file with 22 tests (21 PASS, 1 SKIP): 9 display tests, 3 functional tests, 4 error case tests (empty fields, duplicate email, weak password, API errors), 3 edit error tests (no-change save, duplicate email, group operation failure), 3 edge case tests (rapid role switching, form data preserved after error, group removal via dropdown); all tests executed via Chrome MCP with precise verification details documented
- [client/src/components/Toast.jsx] Increased default toast duration from 5000→10000ms and error duration from 8000→15000ms for reliable UI test verification via Chrome MCP snapshots

- [src/database/migrations/016_add_check_number.js] Created migration adding check_number (string 50, nullable) column to transactions table
- [src/validators/transactions.js] Added checkNumber field (string max 50, nullable, optional) to baseTransactionSchema
- [src/models/Transaction.js] Added check_number support in create (insert), update (allowedFields), and format (camelCase output) methods; extended findByUser search to include check_number field
- [client/src/pages/Transactions.jsx] Added checkNumber field to TransactionModal (conditional on type !== transfer), included checkNumber in handleSave cleanData, added expandable rows with expandedRows state/toggleExpand, Fragment wrapper, chevron icon (w-4 h-4 text-gray-500) and cursor-pointer only on rows with extra details (via hasExpandableDetails), invisible spacer on non-expandable rows to keep type icons aligned, widened first column to w-14, TransactionExpandedRow rendering; added X clear icon inside search field (conditional on searchInput), added hasActiveFilters memo and resetAllFilters callback, added "Réinitialiser" button with RotateCcw icon (visible only when filters/search are active) to reset all filters, search, and date range
- [client/src/components/TransactionExpandedRow.jsx] Created expandable row component displaying notes, check number, tags, value/purchase/accounting dates, recurring flag, and linked account in a responsive grid layout; exported hasExpandableDetails utility to determine if a transaction has expandable content
- [tests/models/Transaction.test.js] Added 8 tests: create expense/income with checkNumber, create without checkNumber defaults to null, update checkNumber, clear checkNumber, format with/without check_number, search by check number
- [tests/integration/transactions.test.js] Added 4 tests: POST with checkNumber, PUT checkNumber, GET returns checkNumber, search by checkNumber
- [client/tests/components/TransactionExpandedRow.test.jsx] Created 21 tests: 11 hasExpandableDetails tests (false for no details, true for notes/checkNumber/tags/dates/recurring/linkedAccount, false for empty tags and transfer without link), 10 rendering tests (check number, notes, tags, recurring, linked account, status not rendered, null checkNumber not rendered, value/purchase dates, multiple details together)
- [client/tests/ui/transactions/search-check-number.ui.test.js] Created 5 UI tests: search by full check number, search by partial check number, search matching description OR check number, no results for non-existent check number, restore full list when clearing search
- [client/tests/ui/transactions/search-filters.ui.test.js] Created 8 UI tests: 3 search clear button tests (hidden when empty, visible when typing, clears text on click), 5 filter reset button tests (hidden when no filters, visible when filter/search active, resets all filters and search, resets date filters and quick period)

## Notes
No backend changes required. All logic is frontend-only. Bug found and fixed: API returns `memberRole` field for group memberships but frontend code accessed `role`, causing group roles to always display as "Membre" regardless of actual value. Chrome MCP `fill` tool cannot select `<option value="">` (empty value); workaround uses evaluate_script with nativeInputValueSetter + dispatchEvent.

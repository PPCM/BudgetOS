# Changelog - 2026-01-31

## Summary
Unified UserModal for create and edit modes with conditional group management based on role, Langue/Devise in both modes, and form-based batch save approach. Added error handling and edge case tests. Increased toast durations for reliable UI test verification. Executed all 22 UI tests via Chrome MCP (21 PASS, 1 SKIP). Added check_number field to transactions and expandable detail rows in the transaction list. Extended transaction search to include check_number field (partial match). Added search clear icon and filter reset button. Major refactoring of the bank import system: unified analyze/confirm flow replacing old preview/process/validate, CB card detection, payee alias learning, and full review UI with editable actions. Added credit card selection field to transaction modal with mutual exclusivity between credit card and check number. Replaced import action dropdown with 3 clickable icons (PlusCircle/XCircle/CheckCircle), auto-expand matched transaction details, read-only payee for match action. Added manual matching: CheckCircle always clickable (fetches candidates via new endpoint), candidate selection, "Changer" button to switch matched transaction, payeeName from backend join.

## Changes

- [client/src/pages/AdminUsers.jsx] Added pendingGroups state (create), localGroups state (edit), handleRoleChange handler, computeGroupChanges diff, and conditional group UI: super_admin hides groups entirely, user shows simple "Groupe" dropdown (both create and edit), admin supports multi-group "Groupes" management (both modes); unified Langue/Devise fields for both create and edit; added handleUserGroupChange handler and userGroupId computed value for unified user dropdown; edit mode refactored to form-based approach (local state, batch save on submit with toAdd/toRemove/toUpdateRole); removed individual group mutation callbacks; fixed memberRole→role normalization bug in useEffect sync and computeGroupChanges (API returns memberRole, frontend expected role); fixed create mode stripping empty firstName/lastName before sending to avoid Zod min(1) validation error
- [client/tests/pages/AdminUsers.test.jsx] Updated 7 tests for unified form behavior; added 16 error/edge case tests: API error handling for create, update, suspend, reactivate, role change (toast messages with server/fallback messages), empty field stripping, HTML required/minLength validation attributes, no-change edit closes modal, graceful handling of getUsers/getUser API failures, modal stays open after create error; total 66 tests passing
- [client/tests/ui/admin/users-groups.ui.test.js] Updated UI test file with 22 tests (21 PASS, 1 SKIP): 9 display tests, 3 functional tests, 4 error case tests (empty fields, duplicate email, weak password, API errors), 3 edit error tests (no-change save, duplicate email, group operation failure), 3 edge case tests (rapid role switching, form data preserved after error, group removal via dropdown); all tests executed via Chrome MCP with precise verification details documented
- [client/src/components/Toast.jsx] Increased default toast duration from 5000→10000ms and error duration from 8000→15000ms for reliable UI test verification via Chrome MCP snapshots

- [src/database/migrations/016_add_check_number.js] Created migration adding check_number (string 50, nullable) column to transactions table
- [src/validators/transactions.js] Added checkNumber field (string max 50, nullable, optional) to baseTransactionSchema
- [src/models/Transaction.js] Added check_number support in create (insert), update (allowedFields), and format (camelCase output) methods; extended findByUser search to include check_number field
- [client/src/pages/Transactions.jsx] Added checkNumber field to TransactionModal (conditional on type !== transfer), included checkNumber in handleSave cleanData, added expandable rows with expandedRows state/toggleExpand, Fragment wrapper, chevron icon (w-4 h-4 text-gray-500) and cursor-pointer only on rows with extra details (via hasExpandableDetails), invisible spacer on non-expandable rows to keep type icons aligned, widened first column to w-14, TransactionExpandedRow rendering; added X clear icon inside search field (conditional on searchInput), added hasActiveFilters memo and resetAllFilters callback, added "Réinitialiser" button with RotateCcw icon right-aligned on the date/period row (visible only when filters/search are active) to reset all filters, search, and date range; added credit card field to TransactionModal: imported creditCardsApi and CreditCard icon, added useQuery for credit cards, passed creditCards prop to modal, added creditCardId to formData state, replaced checkNumber field with mutually exclusive "Moyen de paiement" selector (two buttons "Carte"/"Chèque" → selecting one hides the other with × cancel button to reset), updated handleSave with creditCardId/checkNumber exclusivity logic, updated handleEdit to include creditCardId
- [client/src/components/TransactionExpandedRow.jsx] Created expandable row component displaying notes, check number, tags, value/purchase/accounting dates, recurring flag, and linked account in a responsive grid layout; exported hasExpandableDetails utility to determine if a transaction has expandable content
- [tests/models/Transaction.test.js] Added 8 tests: create expense/income with checkNumber, create without checkNumber defaults to null, update checkNumber, clear checkNumber, format with/without check_number, search by check number
- [tests/integration/transactions.test.js] Added 4 tests: POST with checkNumber, PUT checkNumber, GET returns checkNumber, search by checkNumber
- [client/tests/components/TransactionExpandedRow.test.jsx] Created 21 tests: 11 hasExpandableDetails tests (false for no details, true for notes/checkNumber/tags/dates/recurring/linkedAccount, false for empty tags and transfer without link), 10 rendering tests (check number, notes, tags, recurring, linked account, status not rendered, null checkNumber not rendered, value/purchase dates, multiple details together)
- [client/tests/ui/transactions/search-check-number.ui.test.js] Created 5 UI tests (all PASS via Chrome MCP): search by full check number, search by partial check number, search matching description OR check number, no results for non-existent check number, restore full list when clearing search
- [client/tests/ui/transactions/search-filters.ui.test.js] Created 8 UI tests (all PASS via Chrome MCP): 3 search clear button tests (hidden when empty, visible when typing, clears text on click), 5 filter reset button tests (hidden when no filters, visible on period row when filter/search active, resets all filters and search, resets date filters and quick period)

- [.gitignore] Added examples/ directory exclusion
- [src/database/migrations/017_improve_import_system.js] Created migration: payee_aliases table with normalized_pattern unique index, added parsed_data/match_results/matched_count columns to imports table
- [src/utils/bankPatterns.js] Created bank pattern extraction utilities: extractCBCardLast4, extractPurchaseDate, extractMerchantPattern, analyzeBankDescription
- [src/utils/helpers.js] Enhanced calculateMatchScore with check_number (+10) and suggestedPayeeId (+5) bonus scoring
- [src/models/PayeeAlias.js] Created PayeeAlias model with create, findByPattern, findBestMatch (exact then substring matching), learnAlias (upsert), findByPayee, delete methods
- [src/services/importService.js] Complete refactoring: replaced old createImport/findMatches/processImport with analyzeImport (parse+enrich+match in one step storing results in DB), enrichTransactions (CB detection + payee alias matching), confirmImport (with alias learning and CC cycle assignment); findMatches now uses date-range filtering instead of limit(1000); added formatExistingTx helper
- [src/controllers/importController.js] Replaced uploadFile/previewImport/processImport/validateImport with analyzeImport/confirmImport endpoints
- [src/routes/import.js] Replaced /upload, /preview, /process, /validate routes with POST /analyze (multer + rate limiter) and POST /confirm
- [src/validators/import.js] Replaced old importActionSchema/validateImportSchema/startImportSchema/previewImportSchema with confirmActionSchema and confirmImportSchema; added 'analyzing'/'analyzed' status values to listImportsQuerySchema
- [client/src/lib/api.js] Added importApi namespace with analyze (multipart), confirm, getHistory, getOne methods
- [client/src/pages/Import.jsx] Complete rewrite: 3-step wizard (file selection with CSV config → review table with filters/bulk actions/CB badges/payee assignment → result summary), replaced axios direct calls with importApi, added error state display; centered Action column header text
- [client/src/components/ImportReviewRow.jsx] Created review row component with CB card badges (purple=matched, orange=unmatched), expandable matched transaction display; replaced action dropdown with 3 icon buttons (PlusCircle=Créer blue, XCircle=Ignorer gray, CheckCircle=Rapprocher green), CheckCircle disabled with opacity-30 when no match; auto-expand detail row when action=match (no manual chevron), manual chevron toggle for other actions; payee column shows read-only text with Link2 icon when action=match (lookup from matchedTransaction.payeeId), SearchableSelect when action=create, hidden when action=skip; enriched expanded detail row with Tiers column (grid-cols-5)
- [tests/utils/bankPatterns.test.js] Created 28 unit tests for bank pattern extraction
- [tests/models/PayeeAlias.test.js] Created 16 unit tests for PayeeAlias model (create, findByPattern, findBestMatch, learnAlias, findByPayee, delete)
- [tests/setup.js] Added payee_aliases to test database cleanup table list

- [client/tests/ui/import/import-flow.ui.test.js] Chrome MCP full import flow validation (9 tests all PASS): CSV upload+parsing (61 tx), CB*7166 detection (53 tx with orange badge), purchase date extraction, merchant pattern extraction, non-CB transactions without badge, confirm import creates 61 transactions (70 total), re-import detects 61/61 correspondences (score 100), default action "Rapprocher" for matches, bulk action button visible
- [client/tests/ui/import/import-actions.ui.test.js] Created 9 UI tests (all PASS via Chrome MCP): 3 icons visible per row (no dropdown), CheckCircle green by default for correspondences, PlusCircle click activates create + shows SearchableSelect + collapses detail, XCircle click activates skip + hides payee + opacity-50, CheckCircle click activates match + auto-expands detail + read-only payee, disabled CheckCircle for new transactions, expanded detail row includes Tiers column, manual chevron expand when action≠match

- [src/models/Transaction.js] Added findMatchCandidates method: finds candidate transactions for manual import matching (exact amount, ±90 days, excludes reconciled/void, joins payees for payeeName, sorted by date proximity, limit 20); added import_hash field to Transaction.create insert
- [src/services/importService.js] Added LEFT JOIN with payees table in findMatches query to include payee_name; added payeeName field to formatExistingTx; excluded reconciled transactions from amount/date matching (but kept hash-based duplicate detection on all transactions); auto-reconcile newly created transactions during import (is_reconciled=true, reconciled_at set)
- [src/controllers/importController.js] Added getMatchCandidates handler with Zod query validation (accountId, amount, date)
- [src/routes/import.js] Added GET /match-candidates route before /:id to avoid param conflict
- [src/validators/import.js] Added matchCandidatesQuerySchema (accountId uuid, amount coerced number, date YYYY-MM-DD regex)
- [client/src/lib/api.js] Added importApi.getMatchCandidates method
- [client/src/components/ImportReviewRow.jsx] Refactored: unified matchedTx from _matchedTransaction or matchedTransaction; CheckCircle always clickable (fetches candidates when no match, sets action when match exists); added fetchCandidates/selectCandidate functions; added candidates list UI (amber row, clickable items sorted by date); added RefreshCw "Changer" button in expanded detail row; payeeName resolved from backend (matchedTx.payeeName) with fallback to local lookup; added Loader2 spinner during candidate fetch
- [client/src/pages/Import.jsx] Passed accountId prop to ImportReviewRow; handleConfirm now reads _matchedTransaction || matchedTransaction for match action; moved "Modifier les paramètres" and "Confirmer l'import" buttons to step indicator bar (top of page); removed "Rapprocher toutes les correspondances" bulk button (redundant with default match behavior)
- [tests/models/Transaction.test.js] Added 6 tests for findMatchCandidates (exact amount, date proximity sort, excludes reconciled, payeeName, excludes void, no match), added 3 tests for ImportService.findMatches excluding reconciled transactions (excludes reconciled from auto-matching, returns new when only reconciled match, excludes reconciled from duplicate detection)
- [client/tests/ui/import/import-actions.ui.test.js] Updated to 22 tests (all PASS via Chrome MCP): 2 icon display tests, 3 click behavior tests, 6 CheckCircle on new transactions tests (clickable, single candidate, empty candidates, multi-candidate list, candidate selection, multi-candidate selection), 2 change matched transaction tests (RefreshCw button, candidates list with Annuler/select), 1 confirm import with manual matches test (1 created + 2 matched), 3 payee display tests, 1 expanded detail test

- [src/models/CreditCard.js] Fixed SQL syntax error in getBalancesForCards: replaced `.sum(knex.raw('ABS(t.amount) as balance'))` with `.select(knex.raw('SUM(ABS(t.amount)) as balance'))` — alias was inside SUM() causing SQLite syntax error on GET /credit-cards
- [tests/integration/credit-cards.test.js] Added 2 integration tests for deferred card balance: currentCycleBalance returned correctly when open cycle has transactions (42.50), currentCycleBalance returns 0 when no transactions; these tests exercise getBalancesForCards which was the source of the SQL bug

## Notes
No backend changes required. All logic is frontend-only. Bug found and fixed: API returns `memberRole` field for group memberships but frontend code accessed `role`, causing group roles to always display as "Membre" regardless of actual value. Chrome MCP `fill` tool cannot select `<option value="">` (empty value); workaround uses evaluate_script with nativeInputValueSetter + dispatchEvent. The old /upload, /preview, /process, /validate import routes have been fully replaced by /analyze and /confirm. The analyze route handles file upload, parsing, enrichment, and matching in a single call, stores results in the DB, and immediately deletes the temp file (fixing the old bug where /process couldn't access the file after /preview deleted it). Fixed SQL syntax error in CreditCard.getBalancesForCards: `.sum(knex.raw('ABS(t.amount) as balance'))` generated `SUM(ABS(t.amount) as balance)` (alias inside SUM), replaced with `.select(knex.raw('SUM(ABS(t.amount)) as balance'))` which generates correct `SUM(ABS(t.amount)) as balance`.

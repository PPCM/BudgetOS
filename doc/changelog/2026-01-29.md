# Changelog - 2026-01-29

## Summary
Added role-based access control system with 3 levels (super_admin, admin, user) and group management. First registered user becomes super_admin, public registration disabled by default. Also includes earlier performance optimizations, integration/E2E tests, and cross-database compatibility fixes.

## Changes

- [src/database/migrations/014_add_compound_indexes.js] Created migration adding 10 compound indexes on transactions, accounts, credit_card_cycles, planned_transactions, and imports tables
- [src/utils/modelHelpers.js] Created shared utility with camelToSnake, buildUpdates, and paginationMeta functions
- [src/database/dateHelpers.js] Added yearMonth() helper for cross-database YYYY-MM extraction (SQLite, MySQL, PostgreSQL)
- [src/controllers/authController.js] Fixed session race condition in register: added explicit session.save() before responding to ensure session is persisted to file store
- [src/models/CreditCard.js] Eliminated N+1 in findByUser (batch getBalancesForCards) and getCycles (JOIN aggregation), refactored update to use buildUpdates; replaced integer boolean literals (1/0) with native booleans (true/false) for PostgreSQL compatibility in create, findById, findByUser, delete
- [src/models/Transaction.js] Replaced reconcile loop with single batch UPDATE using whereIn, refactored update to use buildUpdates, refactored findByUser to use paginationMeta; replaced integer boolean literals with native booleans for is_recurring, is_reconciled in create, findByUser, reconcile, toggleReconcile
- [src/models/Account.js] Refactored update to use buildUpdates; added Number() coercion for DECIMAL columns in format, updateBalance, calculateTotals, getStats
- [src/models/User.js] Refactored update and updateSettings to use buildUpdates, refactored findAll to use paginationMeta
- [src/models/Category.js] Refactored update to use buildUpdates
- [src/models/Rule.js] Refactored update to use buildUpdates with jsonFields option
- [src/models/PlannedTransaction.js] Refactored update to use buildUpdates with jsonFields option, refactored findByUser to use paginationMeta; replaced integer boolean literals with native booleans for auto_create, execute_before_holiday, delete_on_end, is_active; added Number() coercion for amount in format
- [src/services/reportService.js] Replaced N+1 loop in getMonthlyTrend with single GROUP BY query using yearMonth helper, parallelized getDashboardSummary with Promise.all; added Number() coercion for DECIMAL aggregates and counts
- [src/services/forecastService.js] Parallelized calculateGlobalForecast with Promise.all, batched getMonthlyForecast into 2 grouped queries, fixed double Math.min computation in calculateForecast
- [tests/setup.js] Fixed MySQL resetTestDb: single-connection pool + TRUNCATE TABLE; fixed PG resetTestDb: single-connection pool to prevent deadlocks; added pg DATE type parser and MySQL dateStrings option
- [tests/utils/modelHelpers.test.js] Created 17 unit tests for camelToSnake, buildUpdates, and paginationMeta
- [tests/database/dateHelpers.test.js] Created 7 unit tests for yearMonth and getDialect helpers
- [src/app.js] Created new module exporting createApp() extracted from server.js
- [src/server.js] Removed inline createApp(), now imports from src/app.js
- [src/database/connection.js] Added pg DATE type parser to prevent timezone shifts; added dateStrings: ['DATE'] for MySQL to keep date columns as strings
- [src/utils/modelHelpers.js] Created shared utility with camelToSnake, buildUpdates, and paginationMeta functions; added Number() coercion for total in paginationMeta
- [vitest.config.js] Added exclude for tests/integration/** to separate unit and integration runs; added fileParallelism: false and increased timeout to 30s when TEST_DB_CLIENT targets an external database
- [vitest.integration.config.js] Created separate Vitest config for integration tests (singleFork, 30s timeout)
- [tests/integration/helpers.js] Created test helpers: createTestApp() with mocked DB, createAuthenticatedAgent()
- [tests/integration/health.test.js] Integration tests for GET /api/v1/health (smoke test)
- [tests/integration/auth.test.js] Integration tests for register, login, logout, me, profile, password, settings, CSRF endpoints
- [tests/integration/accounts.test.js] Integration tests for accounts CRUD, recalculate, stats
- [tests/integration/transactions.test.js] Integration tests for transactions CRUD, split, reconcile, match, pagination
- [tests/integration/categories.test.js] Integration tests for categories CRUD, type filtering
- [tests/integration/payees.test.js] Integration tests for payees CRUD, transaction count, reassign
- [tests/integration/credit-cards.test.js] Integration tests for credit cards CRUD, cycles, deferred debit
- [tests/integration/planned-transactions.test.js] Integration tests for planned transactions CRUD, upcoming, occurrence
- [tests/integration/rules.test.js] Integration tests for rules CRUD, test, apply
- [tests/integration/reports.test.js] Integration tests for dashboard, income by category, monthly trend, forecast, comparison
- [tests/integration/security.test.js] Integration tests for 401 without auth, 403 without CSRF, user isolation
- [playwright.config.js] Created Playwright config using system Chrome (channel: 'chrome'), webServer auto-start; added multi-DB support via E2E_DB_TYPE env var with MySQL/PostgreSQL connection variables, increased timeout to 60s
- [e2e/global-setup.js] Created E2E global setup: removes stale DB, checks client/dist; added multi-DB cleanup (PostgreSQL schema reset, MySQL/MariaDB drop all tables via Knex)
- [e2e/helpers/auth.js] Created E2E auth helpers: registerUser, loginUser, loginViaApi, registerViaApi; adapted for RBAC bootstrap flow (first user = super_admin → automatically creates default group and enables public registration for subsequent test users)
- [e2e/auth.spec.js] E2E tests for registration, login, logout, protected access
- [e2e/dashboard.spec.js] E2E tests for dashboard loading, sections, navigation
- [e2e/accounts.spec.js] E2E tests for accounts display, creation via UI and API
- [e2e/transactions.spec.js] E2E tests for transactions display, CRUD via API, filtering
- [e2e/categories.spec.js] E2E tests for categories display, CRUD via API and UI
- [e2e/full-workflow.spec.js] E2E full user journey: register, account, transactions, reports, logout
- [e2e/transactions-advanced.spec.js] Created 9 E2E tests for advanced transaction types: income/expense with all fields, transfers, external transfers, tags, notes, dates, statuses
- [e2e/transactions-filters.spec.js] Created 13 E2E tests for transaction filters: accountId, type, status, date range, amount range, categoryId, search, isReconciled, pagination, sorting, combined filters
- [e2e/validation-errors.spec.js] Created 31 E2E tests for validation errors: transactions (10), accounts (3), categories (3), credit cards (5), payees (2), rules (3), auth (4), settings (1)
- [e2e/credit-cards.spec.js] Created 11 E2E tests for credit cards: CRUD, immediate/deferred types, cycles, current cycle, transaction with creditCardId, cycle debit generation
- [e2e/payees.spec.js] Created 9 E2E tests for payees: CRUD, transaction count, reassign transactions, search by name, duplicate name rejection
- [e2e/rules.spec.js] Created 10 E2E tests for rules: CRUD, sorting, test match/no-match, apply to transaction, multiple operators (contains, starts_with, greater_than, less_than, between, regex)
- [e2e/reports.spec.js] Created 10 E2E tests for reports: dashboard summary, income by category, monthly trend, forecast (global/account/monthly), month comparison, dashboard with data, expenses by category
- [e2e/settings.spec.js] Created 7 E2E tests for settings: default settings, update profile, display settings, notification settings, change password with re-login, reject wrong password, GET /me
- [.husky/pre-commit] Created pre-commit hook running unit tests then integration tests
- [package.json] Added scripts: test:integration, test:all, test:e2e, test:e2e:headed, test:e2e:ui, test:full, prepare, test:e2e:sqlite, test:e2e:postgres, test:e2e:mysql, test:e2e:all-dbs; added devDeps: @playwright/test, husky
- [docker/docker-compose.e2e.yml] Created combined Docker Compose file with PostgreSQL 16 and MariaDB 11 for E2E testing (dedicated budgetos_e2e_test databases)
- [README.md] Added database support table, testing section with all commands, multi-database E2E setup instructions
- [doc/README.md] Updated tech stack (multi-DB via Knex.js), added docker/e2e/tests to project structure, added full testing section (unit, integration, E2E, multi-DB), expanded environment variables with all DB options
- [.gitignore] Added Playwright artifacts, E2E test database

- [src/database/migrations/015_create_groups.js] Created migration for system_settings, groups, and group_members tables with data migration (first admin → super_admin, Default group creation)
- [src/models/SystemSetting.js] Created SystemSetting model with get, set, getAll, getAllFormatted methods
- [src/models/Group.js] Created Group model with full CRUD for groups and members
- [src/models/User.js] Added createByAdmin, reactivate, updateRole methods; modified findByEmail to include inactive users; modified findAll to support groupId filter
- [src/middleware/auth.js] Added requireSuperAdmin, requireGroupAdmin, requireAdminOrSuperAdmin middlewares; updated requireAdmin and requireOwnership to accept super_admin role
- [src/validators/group.js] Created Zod schemas for group CRUD and member operations
- [src/validators/admin.js] Created Zod schemas for admin user management and system settings
- [src/controllers/groupController.js] Created controller for group and member management endpoints
- [src/controllers/adminController.js] Created controller for user administration and system settings endpoints
- [src/controllers/authController.js] Added bootstrap mode (1st user = super_admin), public registration check, login blocking for suspended users, group info in getMe response
- [src/routes/groups.js] Created routes for /api/v1/groups with proper access control middleware
- [src/routes/admin.js] Created routes for /api/v1/admin with super_admin access control
- [src/routes/index.js] Added group and admin route registrations
- [src/database/seeds/001_demo_data.js] Updated admin role to super_admin, added Default group, added demo users with group memberships
- [tests/setup.js] Added group_members, groups, system_settings to reset tables; added createTestGroup, createTestGroupMember, createTestSuperAdmin helpers
- [tests/integration/helpers.js] Rewrote createAuthenticatedAgent to create user in DB and login; added createAuthenticatedSuperAdmin and seedSystemSettings helpers
- [tests/integration/auth.test.js] Adapted all tests for new registration behavior (bootstrap mode, public registration, suspended user login block)
- [tests/models/SystemSetting.test.js] Created unit tests for SystemSetting model
- [tests/models/Group.test.js] Created unit tests for Group model
- [tests/integration/groups.test.js] Created integration tests for group endpoints; added 11 cross-role access control tests: regular user denied listing/update/delete groups and list/add/update/remove members, admin denied update/delete groups, group admin denied cross-group member management (list, update, remove)
- [tests/integration/admin.test.js] Created integration tests for admin endpoints; added 11 cross-role access control tests: admin denied create/suspend/reactivate users and change roles, regular user denied create/suspend users and change roles, admin/user denied settings read, regular user denied settings update
- [e2e/admin.spec.js] Created 24 E2E tests for admin: user management (list, filter, paginate, create, group assignment, get details, suspend, reactivate, prevent self-suspension, change role, prevent self-role-change, reject invalid role), system settings (get, update, reject without default group), access control (deny user listing for user/admin, deny user creation for admin/user, deny suspension for admin/user, deny role change for admin, deny settings for admin/user)
- [e2e/groups.spec.js] Created 22 E2E tests for groups: CRUD (create, list, get details with memberCount, update, deactivate), members (add existing user, create new user as member, list members, update member role, remove member), permissions (get my groups, deny user creation for user/admin, deny listing/update/delete for user, deny update+delete for admin, deny member management for user, group admin access, deny cross-group access, deny cross-group member management, prevent duplicate membership, prevent multi-group membership)
- [e2e/auth-rbac.spec.js] Created 8 E2E tests for auth RBAC: groups in /me response, user role, super_admin role, block suspended user login, allow after reactivation, block registration when disabled, allow registration when enabled, default group assignment
- [e2e/helpers/auth.js] Added loginAsSuperAdmin, createUserViaAdmin, getCsrfToken helpers; added ensureBootstrap pattern for cross-file bootstrap persistence; optimized with login-first approach to avoid costly bcrypt on every bootstrap check
- [e2e/global-setup.js] Fixed SQLite cleanup: replaced file deletion (caused SQLITE_READONLY_DBMOVED) with table truncation via Knex connection since Playwright webServer starts before globalSetup
- [playwright.config.js] Added ...process.env spread to webServer.env to inherit system environment variables (fixes missing PATH, HOME, etc. when Playwright replaces process.env)

## Notes
All 240 unit tests pass on SQLite. 152 integration tests pass (2 skipped due to pre-existing SQL bugs in reportService.getExpensesByCategory and CreditCard.getCycles). E2E Playwright tests: 54 new RBAC tests (24 admin + 22 groups + 8 auth-rbac) + 121 existing; all 54 new RBAC tests pass; 19 pre-existing tests fail due to session file-store performance degradation (timeout cascade), 1 skipped (expenses/category SQL bug).
Role-based access control: the `role` column in users table accepts any string value, so `super_admin` works without schema migration. Group constraint (1 user = 1 group for regular users) is enforced at application level. Dynamic imports used in requireGroupAdmin and authController to avoid circular dependencies.
Playwright webServer starts BEFORE globalSetup — SQLite file deletion in globalSetup caused SQLITE_READONLY_DBMOVED error. Fixed by truncating tables via Knex connection instead.
